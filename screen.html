<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Stream Quick Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body{height:100%;margin:0}
    body{
      display:flex;align-items:center;justify-content:center;gap:16px;flex-direction:column;
      font-family:system-ui,Arial,sans-serif;background:#111;color:#eee
    }
    .wrap{max-width:min(96vw,980px);width:100%;text-align:center}
    #stream{
      width:100%;max-height:80vh;object-fit:contain;background:#000;border-radius:8px
    }
    .note{font-size:14px;color:#bbb}
    .bad{color:#ff6b6b}
    .ok{color:#9be37d}
    .row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:8px}
    input[type=text]{min-width:340px;max-width:70vw;padding:8px;border-radius:6px;border:1px solid #333;background:#1b1b1b;color:#eee}
    button{padding:8px 14px;border:0;border-radius:6px;background:#2c2c2c;color:#fff;cursor:pointer}
    button:hover{background:#3a3a3a}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:0 0 6px">Drone Stream Test</h1>
    <div id="status" class="note">스트림 URL을 확인 중…</div>

    <div class="row">
      <input id="url" type="text" placeholder="http://192.168.137.98:5002/video_feed" crossorigin="anonymous" />
      <button id="btnLoad">불러오기</button>
      <button id="btnBust">캐시무력화</button>
    </div>

    <!-- MJPEG 스트림은 <img>가 가장 호환이 좋습니다 -->
    <img id="stream" alt="Live Stream (MJPEG)" />

    <div class="note" style="margin-top:10px">
      루트(<code>/</code>)에서 <code>404 Not Found</code>는 정상입니다. <code>/video_feed</code> 엔드포인트를 사용하세요.
    </div>
  </div>

  <script>
    // ====== 환경에 맞게 기본값만 바꿔주세요 ======
    const DEFAULT_STREAM_URL = 'http://192.168.137.98:5002/video_feed';

    const $img    = document.getElementById('stream');
    const $url    = document.getElementById('url');
    const $status = document.getElementById('status');
    const $btnLoad= document.getElementById('btnLoad');
    const $btnBust= document.getElementById('btnBust');

    // 혼합 콘텐츠(HTTPS 페이지 ↔ HTTP 스트림) 차단 감지
    function isMixedBlocked(u){
      try{ const x = new URL(u, location.href);
        return location.protocol === 'https:' && x.protocol === 'http:';
      }catch{ return false; }
    }

    function bust(url){
      const sep = url.includes('?') ? '&' : '?';
      return `${url}${sep}_t=${Date.now()}`;
    }

    function setStatus(msg, cls){
      $status.className = 'note ' + (cls || '');
      $status.textContent = msg;
    }

    function loadStream(url){
      if(!url){ setStatus('URL이 비었습니다.', 'bad'); return; }

      if(isMixedBlocked(url)){
        setStatus('HTTPS 페이지에서 HTTP 스트림이 차단되었습니다. 페이지를 HTTP로 열거나, HTTPS 프록시를 사용하세요.', 'bad');
        // 차단 상황에선 로드 시도해도 브라우저가 막음. 그래도 사용자가 보고 확인할 수 있게 fallback 유지.
      }else{
        setStatus('스트림 연결 시도 중…', '');
      }

      // 이미지로 MJPEG 시도
      $img.onload  = () => setStatus('연결 성공 (MJPEG img 로드)', 'ok');
      $img.onerror = () => {
        setStatus('연결 실패. URL과 네트워크를 확인하세요. 루트(/)는 404가 정상이며 /video_feed만 사용합니다.', 'bad');
        // 실패 시 기본 안내 이미지(옵션): 필요하면 경로 교체
        // $img.src = './images/cctv.png';
      };

      $img.src = bust(url);
    }

    // 초기값 셋업 & 이벤트
    $url.value = DEFAULT_STREAM_URL;
    setStatus('URL을 확인했어요. 불러오기를 눌러 테스트하세요.');
    $btnLoad.onclick = () => loadStream($url.value.trim());
    $btnBust.onclick = () => {
      if($img.src) $img.src = bust($img.src.split('?')[0]);
    };

    // 페이지가 HTTP인 경우 자동 로드, HTTPS면 수동 로드 유도
    if(location.protocol === 'http:'){
      loadStream(DEFAULT_STREAM_URL);
    }else{
      setStatus('현재 페이지는 HTTPS입니다. HTTP 스트림은 브라우저가 차단할 수 있어요. 필요시 HTTP로 페이지를 열어 테스트하세요.', 'bad');
    }
  </script>
</body>
</html>
