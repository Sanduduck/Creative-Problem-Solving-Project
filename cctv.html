<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Drone CCTV Viewer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
      margin: 0;
      overflow: hidden;
    }
    #map { flex: 2; height: 100%; }
    .right-panel {
      flex: 1;
      background-color: #f7f7f7;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      overflow-y: auto;
    }
    .search-container { margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
    .search-bar { width: 100%; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; }
    .search-icon { background-color: #000; color: #fff; border: none; padding: 10px 14px; border-radius: 4px; cursor: pointer; }
    .search-icon:hover { background-color: #333; }
    .drone-list { list-style-type: none; padding: 0; margin: 0; }
    .drone-item { display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 10px; border-bottom: 1px solid #ddd; }
    .drone-item:hover { background-color: #f0f0f0; }
    .drone-name { cursor: pointer; flex: 1; }
    .delete-btn { background: #eee; border: 1px solid #ccc; color: #333; width: 28px; height: 28px; border-radius: 4px; cursor: pointer; font-weight: bold; line-height: 1; }
    .delete-btn:hover { background: #e2e2e2; }
    .drone-display { margin-top: 20px; text-align: center; }
    .drone-display p { font-size: 18px; margin-top: 10px; }

    .cctv-expanded {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(1);
      max-width: 85%;
      max-height: 90%;
      z-index: 1000;
      cursor: pointer;
      box-shadow: 0 0 20px rgba(0,0,0,.7);
      transition: transform .4s ease;
    }
    #cctv-image {
      width: 95%;
      max-width: 720px;
      transition: transform .4s ease;
    }
    .cctv-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,.7); z-index: 999; }

    .back-button {
      margin-top: 20px; padding: 10px 20px; background-color: #000; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; display: none;
    }
    .back-button:hover { background-color: #333; }

    .forms h4 { margin: 16px 0 8px; font-size: 16px; }
    .region-row { display: flex; gap: 8px; align-items: center; }
    .region-row input { flex: 1 1 auto; }
    .region-row button { flex: 0 0 auto; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .grid input, .grid select, .grid button { grid-column: 1 / -1; }

    .forms input, .forms select { padding: 8px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; }
    .btn { padding: 10px 24px; background: #000; color: #fff; border: 0; border-radius: 4px; cursor: pointer; }
    .btn:hover { background: #333; }
    .error { color: #c62828; font-size: 13px; display: none; width: 100%; }

    .repository { position: fixed; bottom: 20px; left: 20px; background: #676767; color: #fff; padding: 12px 14px; border-radius: 8px; cursor: pointer; z-index: 1000; }
    .repository:hover { background: #171717; }
    #add-drone-btn { width: 100%; box-sizing: border-box; padding: 8px; font-size: 14px; }

    .notice {
      display: none;
      color: #d32f2f;
      font-size: 14px;
      margin: 10px 0 6px;
      text-align: center;
    }
    .inline-logo { height: 1em; width: auto; vertical-align: -0.12em; margin: 0 6px; }
    .cctv-controls {
      position: fixed;
      z-index: 1001;
      display: flex;
      gap: 12px;
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,.15);
      transform: translateX(-50%);
    }
    .cctv-btn {
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      background: #000;
      color: #fff;
    }
    .cctv-btn:hover { background: #333; }

    .list-controls {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin: 6px 0 6px;
    }
    .sort-btn {
      padding: 6px 10px;
      font-size: 12px;
      border: 1px solid #bbb;
      border-radius: 6px;
      background: #fff;
      cursor: pointer;
    }
    .sort-btn.active { border-color:#000; }

    @media (max-width: 768px) {
      #cctv-image { width: 100%; max-width: none; }
      .cctv-expanded { max-width: 95%; max-height: 95%; }
    }
    @media (max-width: 768px){
      .forms .region-row{
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
      }
      .forms .region-row input{
        width: 100%;
        font-size: 16px;
        min-height: 40px;
      }
      .forms .region-row button{
        width: 100%;
        padding: 10px 24px;
        font-size: 16px;
      }
    }
    .back-login-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #000;
  color: #fff;
  padding: 12px 20px;
  border-radius: 6px;
  font-size: 14px;
  cursor: pointer;
  z-index: 1000;
  border: none;
}
.back-login-btn:hover {
  background: #333;
}
/* ===== Mobile bottom sheet ===== */
@media (max-width: 768px){
  body { overflow: hidden; }                /* ë°”í…€ì‹œíŠ¸ ì—´ë¦´ ë•Œ ë°°ê²½ ìŠ¤í¬ë¡¤ ë°©ì§€ìš© */

  /* ì§€ë„ëŠ” í•­ìƒ ê¹”ë¦¬ê³ , íŒ¨ë„ì€ ê³ ì • í¬ê°œê¸° */
  #map { position: absolute; inset: 0; }

  /* ê¸°ë³¸: íŒ¨ë„ì„ í™”ë©´ í•˜ë‹¨ìœ¼ë¡œ ìˆ¨ê¹€ (translateY(100%)) */
  .right-panel{
    position: fixed;
    left: 0; right: 0; bottom: 0;
    height: min(78vh, 640px);
    transform: translateY(calc(100% - 56px)); /* í—¤ë”(í•¸ë“¤)ë§Œ ë³´ì´ê²Œ */
    transition: transform .28s ease-out;
    border-top-left-radius: 14px;
    border-top-right-radius: 14px;
    box-shadow: 0 -8px 24px rgba(0,0,0,.18);
    z-index: 1002;
    padding-top: 14px;                         /* í•¸ë“¤ ì—¬ë°± */
  }

  /* ì—´ë¦¼ ìƒíƒœ */
  .right-panel.open{
    transform: translateY(0);
  }

  /* íŒ¨ë„ ìƒë‹¨ í•¸ë“¤ë°”(ì‹œê°ì  íŒíŠ¸) */
  .right-panel::before{
    content:"";
    position:absolute; top:8px; left:50%;
    width: 42px; height: 4px;
    transform: translateX(-50%);
    border-radius: 999px;
    background:#c9c9c9;
  }

  /* íŒ¨ë„ í† ê¸€ ë²„íŠ¼ (ì‘ê²Œ ë–  ìˆëŠ” ì›í˜• ë²„íŠ¼) */
  .mobile-toggle{
    position: fixed;
    right: 14px; bottom: 14px;
    z-index: 1003;
    display: inline-flex; align-items: center; gap: 6px;
    padding: 10px 12px;
    border: none; border-radius: 999px;
    background: #000; color:#fff; cursor:pointer;
    box-shadow: 0 6px 16px rgba(0,0,0,.2);
    font-size: 14px; font-weight: 700;
  }
  .mobile-toggle .icon{ font-size: 14px; line-height: 1; }
  .mobile-toggle:active{ transform: translateY(1px); }

  /* ì˜¤ë²„ë ˆì´ (ì—´ë¦´ ë•Œë§Œ í‘œì‹œ) */
  .panel-overlay{
    position: fixed; inset: 0;
    background: rgba(0,0,0,.35);
    z-index: 1001;
    opacity: 0; pointer-events: none;
    transition: opacity .2s ease;
  }
  .panel-overlay.show{
    opacity: 1; pointer-events: auto;
  }

  /* ë°”í…€ì‹œíŠ¸ í—¤ë”ë§Œ ë³´ì¼ ë•Œë„ ë‚´ë¶€ ìš”ì†Œ ë°°ì¹˜ê°€ ë¬´ë„ˆì§€ì§€ ì•Šë„ë¡ */
  .right-panel .search-container{ margin-top: 10px; }
}

/* ë°ìŠ¤í¬íƒ‘ì—ì„  í† ê¸€/ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€ */
@media (min-width: 769px){
  .mobile-toggle, .panel-overlay{ display: none !important; }
}
/* ===== Mobile bottom sheet fix & FABs ===== */
@media (max-width: 768px){
  /* 1) ë ˆì´ì•„ì›ƒ ì •ë¦¬: ë°”í…€ì‹œíŠ¸/ì§€ë„ ê²¹ì¹¨ ë¬¸ì œ ë°©ì§€ */
  body{
    display:block !important;     /* ê¸°ì¡´ flex â†’ ëª¨ë°”ì¼ì—ì„  block */
    height:100svh;                /* ëª¨ë°”ì¼ ì£¼ì†Œì°½ ë³€ë™ ëŒ€ì‘ */
    overflow:hidden;              /* ì‹œíŠ¸ ì—´ë¦´ ë•Œ ë°°ê²½ ìŠ¤í¬ë¡¤ ë°©ì§€ */
  }
  #map{
    position:fixed;
    inset:0;                      /* í™”ë©´ ì „ì²´ì— ì§€ë„ ê³ ì • */
    z-index:0 !important;
  }

  /* 2) ë°”í…€ì‹œíŠ¸: ê¸°ë³¸ì€ í•¸ë“¤ë§Œ ë³´ì´ê²Œ ìˆ¨ê¹€ */
  .right-panel{
    position: fixed !important;
    left: 0; right: 0; bottom: 0;
    width: 100%;
    max-height: 85svh;            /* íŒ¨ë„ ìµœëŒ€ ë†’ì´ */
    height: auto;
    transform: translateY(calc(100% - 56px));   /* í•¸ë“¤ ë°”ë§Œ ë³´ì´ê²Œ */
    transition: transform .28s ease-out;
    border-top-left-radius: 14px;
    border-top-right-radius: 14px;
    box-shadow: 0 -8px 24px rgba(0,0,0,.18);
    z-index: 10020;               /* ì§€ë„/ì˜¤ë²„ë ˆì´ë³´ë‹¤ ìœ„ */
    padding-top: 18px;            /* í•¸ë“¤ ì—¬ë°± */
    background: #f7f7f7;          /* íŒ¨ë„ ë°°ê²½ ì¬í™•ì¸ */
    overflow-y: auto;             /* íŒ¨ë„ ë‚´ë¶€ ìŠ¤í¬ë¡¤ */
  }
  .right-panel.open{ transform: translateY(0); }

  /* í•¸ë“¤ë°” */
  .right-panel::before{
    content:"";
    position:absolute; top:8px; left:50%;
    width: 42px; height: 4px;
    transform: translateX(-50%);
    border-radius: 999px;
    background:#c9c9c9;
  }

  /* 3) ì˜¤ë²„ë ˆì´ */
  .panel-overlay{
    position: fixed; inset: 0;
    background: rgba(0,0,0,.35);
    z-index: 10010;
    opacity: 0; pointer-events: none;
    transition: opacity .2s ease;
  }
  .panel-overlay.show{ opacity: 1; pointer-events: auto; }

  /* 4) ì—´ê¸°/ë‹«ê¸° í† ê¸€ ë²„íŠ¼ (ì‘ì€ ë‘¥ê·¼ ë²„íŠ¼) */
  .mobile-toggle{
    position: fixed;
    right: 14px; bottom: 14px;
    z-index: 10030;               /* ìµœìƒë‹¨ */
    display: inline-flex; align-items: center; gap: 6px;
    padding: 10px 12px;
    border: none; border-radius: 999px;
    background: #000; color:#fff; cursor:pointer;
    box-shadow: 0 6px 16px rgba(0,0,0,.2);
    font-size: 14px; font-weight: 700;
  }
  .mobile-toggle .icon{ font-size: 14px; line-height: 1; }
  .mobile-toggle:active{ transform: translateY(1px); }
}

/* 5) ìƒë‹¨ ê³ ì • FAB (Decode/Main) â€” í•­ìƒ ë§¨ ì•ì— ë…¸ì¶œ */
.fab{
  position: fixed;
  top: 12px;
  z-index: 11000;                /* ëª¨ë“  ìš”ì†Œ ìœ„ */
  background: #000; color:#fff;
  border: none; border-radius: 999px;
  padding: 10px 14px; font-weight: 700; cursor: pointer;
  box-shadow: 0 6px 16px rgba(0,0,0,.24);
}
.fab-left { left: 12px; }
.fab-right{ right: 12px; }
.fab:hover { background:#333; }

/* ë°ìŠ¤í¬íƒ‘ì—ì„œëŠ” ëª¨ë°”ì¼ í† ê¸€/ì˜¤ë²„ë ˆì´ë§Œ ìˆ¨ê¹€ */
@media (min-width: 769px){
  .mobile-toggle, .panel-overlay{ display: none !important; }
}
/* === FAB ë²„íŠ¼ í•­ìƒ ë§¨ ìœ„ === */
.fab{
  position: fixed;
  top: 12px;
  z-index: 11000;
  background: #000; color:#fff;
  border: none; border-radius: 999px;
  padding: 10px 14px;
  font-weight: 700; cursor: pointer;
  box-shadow: 0 6px 16px rgba(0,0,0,.24);
}
.fab-left { left: 12px; }
.fab-right{ right: 12px; }
.fab:hover { background:#333; }

/* === ëª¨ë°”ì¼ ë°”í…€ì‹œíŠ¸ ìŠ¤ì™€ì´í”„ ì „ìš© === */
@media (max-width: 768px){
  body{
    display:block; height:100svh; overflow:hidden;
  }
  #map{
    position:fixed; inset:0; z-index:0;
  }
  .right-panel{
    position:fixed; left:0; right:0; bottom:0;
    width:100%; max-height:85svh;
    background:#f7f7f7;
    transform:translateY(calc(100% - 50px));
    transition:transform .25s ease;
    border-top-left-radius:14px; border-top-right-radius:14px;
    box-shadow:0 -6px 20px rgba(0,0,0,.2);
    z-index:10020;
    overflow-y:auto;
  }
  .right-panel.open{ transform:translateY(0); }
  .right-panel::before{
    content:"";
    position:absolute; top:8px; left:50%;
    width:40px; height:4px;
    transform:translateX(-50%);
    border-radius:999px;
    background:#aaa;
  }
}
/* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
.fab {
  display: none;
}

/* ëª¨ë°”ì¼(768px ì´í•˜)ì—ì„œëŠ” í‘œì‹œ */
@media (max-width: 768px) {
  .fab {
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
}
@media (max-width: 768px) {
  body {
    flex-direction: column; /* ì„¸ë¡œ ë°°ì¹˜ë¡œ ì „í™˜ */
  }

  #map {
    flex: none;
    width: 100%;
    height: 100%; /* ì§€ë„ê°€ ê¸°ë³¸ ì „ì²´ */
  }

  .right-panel {
    position: fixed;
    bottom: -100%;
    left: 0;
    width: 100%;        /* ğŸ‘‰ ëª¨ë°”ì¼ì—ì„œëŠ” ì „ì²´ ë„ˆë¹„ ì°¨ì§€ */
    max-width: 100%;    /* ğŸ‘‰ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì‚ì ¸ë‚˜ê°€ì§€ ì•Šê²Œ */
    height: 85%;        /* ë†’ì´ëŠ” ì¡°ì • ê°€ëŠ¥ */
    transition: bottom 0.4s ease;
    border-top-left-radius: 14px;
    border-top-right-radius: 14px;
    box-shadow: 0 -4px 20px rgba(0,0,0,.25);
    z-index: 1000;
  }

  .right-panel.show {
    bottom: 0;
  }
}

  </style>
</head>
<body>
  <div id="map"></div>

  <div class="right-panel" id="right-panel">
      <!-- â–¼ ëª¨ë°”ì¼ ì „ìš©: íŒ¨ë„ í† ê¸€ ë²„íŠ¼ / ì˜¤ë²„ë ˆì´ -->
  <button id="mobile-toggle" class="mobile-toggle" aria-expanded="false" aria-controls="right-panel">
    <span class="icon" aria-hidden="true">â–²</span>
    <span class="label">ë©”ë‰´ ì—´ê¸°</span>
  </button>
  <div id="panel-overlay" class="panel-overlay" hidden></div>

    <div class="search-container">
      <input type="text" class="search-bar" id="search-bar" placeholder="Enter drone number or name" onkeydown="checkEnter(event)" />
      <button class="search-icon" onclick="searchDrone()" title="Search by ID">&#8594;</button>
    </div>

    <div class="drone-display" id="drone-display"></div>
    <div id="notice" class="notice"></div>

    <div class="list-controls" id="sort-controls">
      <button class="sort-btn" data-mode="insert">ì¶”ê°€ìˆœ</button>
      <button class="sort-btn" data-mode="insertDesc">ì¶”ê°€ì—­ìˆœ</button>
      <button class="sort-btn" data-mode="alpha">ê°€ë‚˜ë‹¤</button>
      <button class="sort-btn" data-mode="alphaDesc">ê°€ë‚˜ë‹¤ì—­ìˆœ</button>
    </div>

    <ul class="drone-list" id="drone-list"></ul>

    <button class="back-button" id="back-button" onclick="goBack()">Back to Region</button>

    <div class="forms">
      <h4>Add Region</h4>
      <div class="region-row">
        <input id="region-name" type="text" placeholder="Region name" />
        <button class="btn" id="add-region-btn" onclick="addRegion()">Add Region</button>
      </div>
      <div id="region-error" class="error"></div>

      <h4>Add Drone</h4>
      <div class="grid" style="margin-top: 6px;">
        <input id="add-name" type="text" placeholder="Drone name" />
        <select id="add-region"></select>
        <input id="add-lat" type="number" step="any" placeholder="Latitude" />
        <input id="add-lng" type="number" step="any" placeholder="Longitude" />
        <button class="btn" id="add-drone-btn" onclick="addDrone()">Add Drone</button>
      </div>
      <div id="add-error" class="error"></div>
    </div>
  </div>

  <div class="repository" id="decode-btn" role="button" aria-label="Open Encrypt/Decrypt">Decode</div>
<button class="back-login-btn" onclick="window.location.href='main.html'">Go to Main</button>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
    const DEFAULT_STREAM_URL = 'http://192.168.137.98:5002/video_feed';

    const regionData = {};

    let regionOrder = Object.keys(regionData);
    let regionSortMode = 'insert';
    let currentRegion = null;
    const markersById = new Map();

    const map = L.map('map').setView([37.5665, 126.9780], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const blackIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-black.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]
    });
    const redIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]
    });

    function getRole(){ return localStorage.getItem('ae_role') === 'admin' ? 'admin' : 'viewer'; }
    function isAdmin(){ return getRole() === 'admin'; }

    function applyRoleUI() {
      const admin = isAdmin();
      document.querySelectorAll('.forms input, .forms select, .forms .btn').forEach(el=>{ el.disabled = !admin; });
      document.querySelectorAll('.delete-btn').forEach(btn=>{ btn.style.display = admin ? '' : 'none'; });
    }

    function normalizeName(s){
      return (s ?? '').toString().normalize('NFKC').toLowerCase().replace(/\s+/g, '');
    }
    function regionExists(name){
      const t = normalizeName(name);
      return Object.keys(regionData).some(r => normalizeName(r) === t);
    }
    function droneNameExists(name){
      const t = normalizeName(name);
      for (const region in regionData){
        const drones = regionData[region] || [];
        if (drones.some(d => normalizeName(d.name) === t)) return true;
      }
      return false;
    }

    function addDroneToMap(drone) {
      const marker = L.marker([drone.lat, drone.lng], { icon: blackIcon }).addTo(map);
      marker.on('click', () => {
        displayDroneInfo(drone);
        map.setView([drone.lat, drone.lng], 18);
      });
      markersById.set(drone.id, marker);
    }
    function removeDroneFromMap(droneId) {
      const marker = markersById.get(droneId);
      if (marker) { map.removeLayer(marker); markersById.delete(droneId); }
    }
    function onStreamConnected(drone) {
      const m = markersById.get(drone.id);
      if (m) m.setIcon(redIcon);
    }
    function onStreamDisconnected(drone) {
      const m = markersById.get(drone.id);
      if (m) m.setIcon(blackIcon);
    }

    function getRegionList() {
      const names = Object.keys(regionData);
      if (regionSortMode === 'insert') {
        const extra = names.filter(n => !regionOrder.includes(n));
        return [...regionOrder, ...extra];
      }
      if (regionSortMode === 'insertDesc') {
        const base = getRegionListForInsertOnly();
        return base.slice().reverse();
      }
      if (regionSortMode === 'alpha') {
        return names.slice().sort((a,b)=>a.localeCompare(b, 'ko'));
      }
      if (regionSortMode === 'alphaDesc') {
        return names.slice().sort((a,b)=>b.localeCompare(a, 'ko'));
      }
      return names;
    }
    function getRegionListForInsertOnly() {
      const names = Object.keys(regionData);
      const extra = names.filter(n => !regionOrder.includes(n));
      return [...regionOrder, ...extra];
    }

    function renderRegionNames() {
      const list = document.getElementById('drone-list');
      list.innerHTML = '';
      const regions = getRegionList();
      regions.forEach(region => {
        const li = document.createElement('li');
        li.className = 'drone-item';
        li.innerHTML = `
          <span class="drone-name">${region}</span>
          <button class="delete-btn" title="Delete Region">Ã—</button>
        `;
        li.querySelector('.drone-name').onclick = () => displayRegion(region);
        li.querySelector('.delete-btn').onclick = (e) => {
          e.stopPropagation();
          deleteRegion(region);
        };
        list.appendChild(li);
      });

      document.querySelectorAll('.sort-btn').forEach(b=>{
        b.classList.toggle('active', b.dataset.mode === regionSortMode);
      });
      applyRoleUI();
    }

    function renderRegionList(region) {
      const list = document.getElementById('drone-list');
      list.innerHTML = '';
      (regionData[region] || []).forEach(drone => {
        const li = document.createElement('li');
        li.className = 'drone-item';
        li.innerHTML = `
          <span class="drone-name">${drone.name}</span>
          <button class="delete-btn" title="Delete">Ã—</button>
        `;
        li.querySelector('.drone-name').onclick = () => {
          displayDroneInfo(drone);
          map.setView([drone.lat, drone.lng], 18);
        };
        li.querySelector('.delete-btn').onclick = (e) => {
          e.stopPropagation();
          deleteDrone(region, drone.id);
        };
        list.appendChild(li);
      });
      applyRoleUI();
    }

    // displayRegion í•¨ìˆ˜ë¥¼ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.
    function displayRegion(region) {
      currentRegion = region;
      renderRegionList(region);
      document.getElementById('back-button').style.display = 'block';

      const drones = regionData[region] || [];
      if (drones.length > 0) {
        const bounds = L.latLngBounds(drones.map(d => [d.lat, d.lng]));
        map.fitBounds(bounds, { padding: [40, 40], maxZoom: 14 });
      }
    }

    function getStreamUrl(drone) {
      const base = drone.stream || DEFAULT_STREAM_URL;
      const sep = base.includes('?') ? '&' : '?';
      return `${base}${sep}_t=${Date.now()}`;
    }

    function displayDroneInfo(drone) {
      const display = document.getElementById('drone-display');
      const streamUrl = getStreamUrl(drone);

      display.innerHTML = `
        <p>${drone.name} <img src="./images/logo2.png" alt="logo" class="inline-logo" /> (${drone.lat}, ${drone.lng})</p>
        <img src="${streamUrl}" id="cctv-image" alt="Live CCTV Stream" crossorigin="anonymous" />
      `;

      document.getElementById('back-button').style.display = 'block';

      const img = document.getElementById('cctv-image');

      img.addEventListener('load', () => {
        const same = img.src.indexOf(streamUrl) === 0 || img.src === streamUrl;
        if (same) onStreamConnected(drone);
      }, { once: true });

      img.addEventListener('error', () => {
        showNotice('ìŠ¤íŠ¸ë¦¼ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì„ì‹œ ì´ë¯¸ì§€ë¡œ í‘œì‹œ)');
        img.src = './images/cctv.png';
        onStreamDisconnected(drone);
      }, { once: true });

      img.onclick = () => toggleCCTVZoom();
    }

    function toggleCCTVZoom() {
      const img = document.getElementById('cctv-image');
      const overlay = document.querySelector('.cctv-overlay');

      if (img.classList.contains('cctv-expanded')) {
        img.classList.remove('cctv-expanded');
        stopRecorder();
        removeControls();
        if (overlay) overlay.remove();
      } else {
        img.classList.add('cctv-expanded');
        if (!overlay) {
          const newOverlay = document.createElement('div');
          newOverlay.className = 'cctv-overlay';
          newOverlay.onclick = toggleCCTVZoom;
          document.body.appendChild(newOverlay);
        }
        createControlsForImage(img);
        startRecorderFromImage(img);
      }
    }

    function createControlsForImage(img) {
      removeControls();

      const controls = document.createElement('div');
      controls.id = 'cctv-controls';
      controls.className = 'cctv-controls';
      controls.innerHTML = `
        <button type="button" class="cctv-btn" id="btn-capture">ìº¡ì³</button>
        <button type="button" class="cctv-btn" id="btn-save">ì§€ê¸ˆê¹Œì§€ ë…¹í™” ì €ì¥</button>
      `;
      controls.addEventListener('click', e => e.stopPropagation());
      controls.addEventListener('mousedown', e => e.stopPropagation());
      document.body.appendChild(controls);

      positionControls(img, controls);
      requestAnimationFrame(() => positionControls(img, controls));

      controls._onResize = () => positionControls(img, controls);
      window.addEventListener('resize', controls._onResize);
      window.addEventListener('scroll', controls._onResize, { passive: true });

      controls._onTransitionEnd = (e) => {
        if (e.propertyName === 'transform') positionControls(img, controls);
      };
      img.addEventListener('transitionend', controls._onTransitionEnd);

      if ('ResizeObserver' in window) {
        const ro = new ResizeObserver(() => positionControls(img, controls));
        ro.observe(img);
        controls._ro = ro;
      }

      controls._settleTimer = setTimeout(() => positionControls(img, controls), 450);

      document.getElementById('btn-capture').onclick = (e)=>{ 
        e.stopPropagation(); 
        captureCurrentFrameEncrypted(); 
      };
      document.getElementById('btn-save').onclick = async (e)=>{
        e.stopPropagation();
        try { await saveRecordingEncrypted(); } catch(err){ console.error(err); }
      };
    }

    function positionControls(img, controls) {
      if (!img || !controls) return;
      const r = img.getBoundingClientRect();
      controls.style.left = '50%';
      const top = Math.min(
        window.innerHeight - (controls.offsetHeight || 0) - 12,
        r.bottom + 12
      );
      controls.style.top = `${Math.max(12, top)}px`;
    }

    function removeControls() {
      const controls = document.getElementById('cctv-controls');
      if (!controls) return;
      window.removeEventListener('resize', controls._onResize);
      window.removeEventListener('scroll', controls._onResize);
      const img = document.getElementById('cctv-image');
      if (img && controls._onTransitionEnd) {
        img.removeEventListener('transitionend', controls._onTransitionEnd);
      }
      if (controls._ro && controls._ro.disconnect) {
        controls._ro.disconnect();
      }
      if (controls._settleTimer) {
        clearTimeout(controls._settleTimer);
      }
      controls.remove();
    }

    function deleteDrone(region, id) {
      if (!isAdmin()) { showNotice('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (ê´€ë¦¬ì ì „ìš©)'); return; }
      regionData[region] = (regionData[region] || []).filter(d => d.id !== id);
      removeDroneFromMap(id);
      renderRegionList(region);
      document.getElementById('drone-display').innerHTML = '';
      saveAll();
    }

    function deleteRegion(region) {
      if (!isAdmin()) { showNotice('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (ê´€ë¦¬ì ì „ìš©)'); return; }
      (regionData[region] || []).forEach(drone => removeDroneFromMap(drone.id));
      delete regionData[region];
      regionOrder = regionOrder.filter(r => r !== region);
      if (currentRegion === region) {
        currentRegion = null;
        document.getElementById('back-button').style.display = 'none';
        document.getElementById('drone-display').innerHTML = '';
      }
      renderRegionNames();
      updateRegionDropdown();
      saveAll();
    }

    function goBack() {
      currentRegion = null;
      document.getElementById('drone-display').innerHTML = '';
      renderRegionNames();
      document.getElementById('back-button').style.display = 'none';
    }

    function searchDrone() {
      const input = document.getElementById('search-bar').value.trim();
      if (!input) {
        alert('Please enter a drone ID or name.');
        return;
      }

      const numericId = parseInt(input);
      let found = null;

      // Case 1: Search by ID if the input is a valid number
      if (!isNaN(numericId)) {
        for (const region in regionData) {
          found = (regionData[region] || []).find(d => d.id === numericId);
          if (found) break;
        }
      }

      // Case 2: If no drone was found by ID, try searching by name
      if (!found) {
        const normalizedInput = normalizeName(input);
        for (const region in regionData) {
          found = (regionData[region] || []).find(d => normalizeName(d.name) === normalizedInput);
          if (found) break;
        }
      }

      if (found) {
        displayDroneInfo(found);
        map.setView([found.lat, found.lng], 18);
        document.getElementById('back-button').style.display = 'block';
      } else {
        alert('Not found');
      }
    }
    
    function checkEnter(e) { if (e.key === 'Enter') searchDrone(); }

    function getNextDroneId() {
      let max = 0;
      for (const region in regionData) {
        (regionData[region] || []).forEach(d => { if (d.id > max) max = d.id; });
      }
      return max + 1;
    }

    function showNotice(msg) {
      const el = document.getElementById('notice');
      el.textContent = msg;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 3000);
    }

    function addDrone() {
      if (!isAdmin()) { showNotice('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (ê´€ë¦¬ì ì „ìš©)'); return; }
      const name   = (document.getElementById('add-name').value || '').trim();
      const lat    = parseFloat(document.getElementById('add-lat').value);
      const lng    = parseFloat(document.getElementById('add-lng').value);
      const region = document.getElementById('add-region').value;
      const err    = document.getElementById('add-error');

      if (!name || isNaN(lat) || isNaN(lng) || !region) {
        err.innerText = 'Fill all fields';
        err.style.display = 'block';
        return;
      }
      if (droneNameExists(name)) {
        err.innerText = 'ì´ë¯¸ ê°™ì€ ì´ë¦„ì˜ ë“œë¡ ì´ ì¡´ì¬í•©ë‹ˆë‹¤.';
        err.style.display = 'block';
        return;
      }

      err.style.display = 'none';

      const newDrone = { id: getNextDroneId(), name, lat, lng };
      (regionData[region] || (regionData[region] = [])).push(newDrone);

      addDroneToMap(newDrone);
      if (currentRegion === region) renderRegionList(region); else renderRegionNames();

      showNotice('ë“œë¡ ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
      document.getElementById('add-name').value = '';
      document.getElementById('add-lat').value  = '';
      document.getElementById('add-lng').value  = '';

      saveAll();
    }

    function addRegion() {
      if (!isAdmin()) { showNotice('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (ê´€ë¦¬ì ì „ìš©)'); return; }
      const name = (document.getElementById('region-name').value || '').trim();
      const err  = document.getElementById('region-error');

      if (!name) { err.innerText = 'Region name is required'; err.style.display = 'block'; return; }
      if (regionExists(name)) { err.innerText = 'ì´ë¯¸ ì¶”ê°€ëœ ì§€ì—­ì…ë‹ˆë‹¤.'; err.style.display = 'block'; return; }

      err.style.display = 'none';
      regionData[name] = [];
      regionOrder.push(name);
      renderRegionNames();
      updateRegionDropdown();
      document.getElementById('region-name').value = '';
      saveAll();
    }

    function updateRegionDropdown() {
      const sel = document.getElementById('add-region');
      sel.innerHTML = '';
      Object.keys(regionData).forEach(r => {
        const opt = document.createElement('option');
        opt.value = r; opt.innerText = r; sel.appendChild(opt);
      });
    }

    document.getElementById('decode-btn')?.addEventListener('click', () => {
      window.location.href = 'en%26decode.html';
    });

    document.getElementById('sort-controls').addEventListener('click', (e)=>{
      const btn = e.target.closest('.sort-btn');
      if (!btn) return;
      regionSortMode = btn.dataset.mode;
      renderRegionNames();
    });

    const LS_KEYS = {
      data:  'ae_regionData_v1',
      order: 'ae_regionOrder_v1'
    };

    function saveAll(){
      try{
        localStorage.setItem(LS_KEYS.data,  JSON.stringify(regionData));
        localStorage.setItem(LS_KEYS.order, JSON.stringify(regionOrder));
      }catch(e){ console.warn('[persist] save failed', e); }
    }

    function loadAll(){
      try{
        const d = localStorage.getItem(LS_KEYS.data);
        const o = localStorage.getItem(LS_KEYS.order);
        if (d){
          const parsed = JSON.parse(d);
          if (parsed && typeof parsed === 'object'){
            Object.keys(regionData).forEach(k => delete regionData[k]);
            Object.keys(parsed).forEach(k => regionData[k] = parsed[k]);
          }
        }
        if (o){
          const arr = JSON.parse(o);
          if (Array.isArray(arr)) regionOrder = arr;
        }
      }catch(e){ console.warn('[persist] load failed', e); }
    }

    window.onload = () => {
      loadAll();
      renderRegionNames();
      for (const region in regionData) {
        (regionData[region] || []).forEach(drone => addDroneToMap(drone));
      }
      updateRegionDropdown();
      applyRoleUI();

      const _regionNameInput = document.getElementById('region-name');
      if (_regionNameInput) {
        _regionNameInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') { e.preventDefault(); addRegion(); }});
      }
      ['add-name','add-lat','add-lng','add-region'].forEach(id=>{
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') { e.preventDefault(); addDrone(); }});
      });
    };

    /* ===== Recording / Capture + Encryption ===== */
    const MAGIC = new TextEncoder().encode('VIDENC01');
    const ALG_ID = 1;
    const DEFAULT_ITERS = 310000;

    function u32(n){ const b=new Uint8Array(4); new DataView(b.buffer).setUint32(0,n,true); return b; }
    function concatBytes(...arrs){
      let len=0; for(const a of arrs) len+=a.byteLength||a.length;
      const out=new Uint8Array(len); let off=0;
      for(const a of arrs){ const v=a instanceof Uint8Array? a : new Uint8Array(a); out.set(v, off); off+=v.byteLength; }
      return out;
    }
    async function deriveKey(password, salt, iterations=DEFAULT_ITERS){
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']);
      return crypto.subtle.deriveKey(
        { name:'PBKDF2', hash:'SHA-256', salt, iterations },
        keyMaterial,
        { name:'AES-GCM', length:256 },
        false,
        ['encrypt','decrypt']
      );
    }
    async function encryptBlobToVenc(blob, filename, password){
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const iv   = crypto.getRandomValues(new Uint8Array(12));
      const key  = await deriveKey(password, salt, DEFAULT_ITERS);

      const pt   = new Uint8Array(await blob.arrayBuffer());
      const ct   = new Uint8Array(await crypto.subtle.encrypt({ name:'AES-GCM', iv }, key, pt));

      const enc = new TextEncoder();
      const nameBytes = enc.encode(filename || 'capture.png');
      const mimeBytes = enc.encode(blob.type || 'image/png');

      const header = concatBytes(
        MAGIC,
        u32(ALG_ID), u32(DEFAULT_ITERS),
        u32(salt.byteLength), u32(iv.byteLength),
        u32(nameBytes.byteLength), u32(mimeBytes.byteLength),
        salt, iv, nameBytes, mimeBytes
      );
      return new Blob([header, ct], { type:'application/octet-stream' });
    }

    function askPassword(purposeText){
      const pw = prompt(`${purposeText}ì— ì‚¬ìš©í•  ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”\n(en&decode.htmlì—ì„œ ë³µí˜¸í™” ì‹œ ë™ì¼ ë¹„ë°€ë²ˆí˜¸ í•„ìš”)`);
      if (!pw) {
        showNotice('ì•”í˜¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
        throw new Error('password_cancelled');
      }
      return pw;
    }

    const rec = { canvas:null, ctx:null, stream:null, recorder:null, chunks:[], rafId:null };

    function supportsMime(m){
      return typeof MediaRecorder !== 'undefined' && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(m);
    }

    function startRecorderFromImage(img){
      stopRecorder();
      if(!img || !img.complete || img.naturalWidth === 0){
        showNotice('ì´ë¯¸ì§€ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
        return;
      }
      const cw = img.naturalWidth, ch = img.naturalHeight;
      const canvas = document.createElement('canvas');
      canvas.width = cw; canvas.height = ch;
      const ctx = canvas.getContext('2d', { willReadFrequently:true });

      function draw(){
        try{ ctx.drawImage(img, 0, 0, cw, ch); }
        catch(e){ console.error('drawImage error (CORS?)', e); showNotice('CORS ë¬¸ì œë¡œ ë…¹í™”/ìº¡ì²˜ê°€ ì œí•œë©ë‹ˆë‹¤. ì„œë²„ì— Access-Control-Allow-Origin í—¤ë”ë¥¼ ì„¤ì •í•˜ì„¸ìš”.'); stopRecorder(); return; }
        rec.rafId = requestAnimationFrame(draw);
      }
      rec.canvas = canvas; rec.ctx = ctx;
      const stream = canvas.captureStream(30); rec.stream = stream;
      let mime = 'video/webm;codecs=vp9'; if (!supportsMime(mime)) mime = 'video/webm;codecs=vp8'; if (!supportsMime(mime)) mime = 'video/webm';
      try{
        const recorder = new MediaRecorder(stream, { mimeType: mime, videoBitsPerSecond: 4_000_000 });
        recorder.ondataavailable = (e)=>{ if(e.data && e.data.size>0) rec.chunks.push(e.data); };
        recorder.start(1000); rec.recorder = recorder; draw();
      }catch(e){ console.error('MediaRecorder ì‹œì‘ ì‹¤íŒ¨', e); showNotice('ë¸Œë¼ìš°ì €ê°€ MediaRecorderë¥¼ ì§€ì›í•˜ì§€ ì•Šê±°ë‚˜ ê¶Œí•œ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.'); stopRecorder(); }
    }

    function stopRecorder(){
      try{
        if(rec.rafId){ cancelAnimationFrame(rec.rafId); rec.rafId = null; }
        if(rec.recorder && rec.recorder.state !== 'inactive'){ rec.recorder.stop(); }
        if(rec.stream){ rec.stream.getTracks().forEach(t=>t.stop()); }
      }catch(e){}
      rec.recorder = null; rec.stream = null; rec.canvas = null; rec.ctx = null;
    }

    async function captureCurrentFrameEncrypted(){
      try{
        const img = document.getElementById('cctv-image');
        if(!img){ showNotice('ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
        if(!img.complete || img.naturalWidth === 0){ showNotice('í”„ë ˆì„ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.'); return; }

        const canvas = document.createElement('canvas');
        canvas.width  = img.naturalWidth;
        canvas.height = img.naturalHeight;
        const ctx = canvas.getContext('2d', { willReadFrequently:true });
        try{ ctx.drawImage(img, 0, 0); }
        catch(e){ console.error('drawImage error (CORS?)', e); showNotice('CORS ë¬¸ì œë¡œ ìº¡ì²˜ê°€ ì œí•œë©ë‹ˆë‹¤. ì„œë²„ì— CORS í—¤ë”ë¥¼ ì„¤ì •í•˜ì„¸ìš”.'); return; }

        const pngBlob = await new Promise((resolve)=> canvas.toBlob(resolve, 'image/png', 0.92));
        if(!pngBlob){ showNotice('ìº¡ì²˜ ì‹¤íŒ¨(ìº”ë²„ìŠ¤)'); return; }

        const pw = askPassword('ìº¡ì²˜ íŒŒì¼ ì•”í˜¸í™”');
        const ts = new Date().toISOString().replace(/[:.]/g,'-');
        const baseName = `capture_${ts}.png`;
        const vencBlob = await encryptBlobToVenc(pngBlob, baseName, pw);

        const a = document.createElement('a');
        a.href = URL.createObjectURL(vencBlob);
        a.download = baseName + '.venc';
        document.body.appendChild(a);
        a.click();
        setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 1000);
        showNotice('ìº¡ì²˜ ì €ì¥ ì™„ë£Œ(ì•”í˜¸í™”).');
      }catch(err){
        if (err?.message !== 'password_cancelled') { console.error(err); showNotice('ìº¡ì²˜ ì˜¤ë¥˜: ' + (err?.message || String(err))); }
      }
    }

    async function saveRecordingEncrypted(){
      try{
        if (!rec) { showNotice('ë…¹í™” ìƒíƒœê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
        await new Promise(resolve=>{
          if (rec.recorder && rec.recorder.state !== 'inactive') { rec.recorder.onstop = resolve; try { rec.recorder.stop(); } catch(e){ resolve(); } }
          else { resolve(); }
        });

        const blob = new Blob(rec.chunks.slice(), { type:'video/webm' });
        rec.chunks.length = 0;

        if (!blob || blob.size === 0) {
          showNotice('ì €ì¥í•  ë…¹í™” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
          const img = document.getElementById('cctv-image');
          if (img) startRecorderFromImage(img);
          return;
        }

        const pw = askPassword('ë…¹í™” íŒŒì¼ ì•”í˜¸í™”');
        const ts = new Date().toISOString().replace(/[:.]/g,'-');
        const baseName = `record_${ts}.webm`;
        const vencBlob = await encryptBlobToVenc(blob, baseName, pw);

        const a = document.createElement('a');
        a.href = URL.createObjectURL(vencBlob);
        a.download = baseName + '.venc';
        document.body.appendChild(a);
        a.click();
        setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 1000);
        showNotice('ë…¹í™” ì €ì¥ ì™„ë£Œ(ì•”í˜¸í™”).');

        const img = document.getElementById('cctv-image');
        if (img) startRecorderFromImage(img);
      }catch(err){
        if (err?.message !== 'password_cancelled') { console.error(err); showNotice('ë…¹í™” ì €ì¥ ì˜¤ë¥˜: ' + (err?.message || String(err))); }
      }
    }

    /* ===== Reverse Geocoding (global) ===== */
    const NOMINATIM_BASE = 'https://nominatim.openstreetmap.org/reverse';
    const USER_AGENT_CONTACT = 'DroneCCTVViewer/1.0 (your-email@example.com)';

    const _revCache = new Map();
    function _cacheKey(lat, lng) {
      const kLat = (Math.round(lat * 20000) / 20000).toFixed(5);
      const kLng = (Math.round(lng * 20000) / 20000).toFixed(5);
      return `${kLat},${kLng}`;
    }

    async function getRegionNameFromCoords(lat, lng) {
      const key = _cacheKey(lat, lng);
      if (_revCache.has(key)) return _revCache.get(key);

      const url = `${NOMINATIM_BASE}?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lng)}&zoom=10&accept-language=ko`;
      let region = null;
      try {
        const res = await fetch(url, { headers: { 'User-Agent': USER_AGENT_CONTACT } });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const addr = data.address || {};

        const cityLike = addr.city || addr.municipality || addr.town || addr.city_district || addr.county || addr.region;
        const stateLike = addr.state || addr.province;
        region = normalizeKoreanRegion(cityLike || stateLike || null);
      } catch (e) {
        console.warn('Reverse geocode failed:', e);
      }
      _revCache.set(key, region);
      return region;
    }

    function normalizeKoreanRegion(name) {
      if (!name || typeof name !== 'string') return null;
      let s = name.trim();

      s = s.replace(/íŠ¹ë³„ì‹œ$/,'')
           .replace(/ê´‘ì—­ì‹œ$/,'')
           .replace(/íŠ¹ë³„ìì¹˜ì‹œ$/,'')
           .replace(/íŠ¹ë³„ìì¹˜ë„$/,'')
           .replace(/ìì¹˜ì‹œ$/,'')
           .replace(/ìì¹˜ë„$/,'')
           .replace(/ë„$/,'')
           .replace(/ì‹œ$/,'')
           .replace(/êµ°$/,'')
           .replace(/êµ¬$/,'');

      const map = { 'ì„œìš¸':'ì„œìš¸','ë¶€ì‚°':'ë¶€ì‚°','ëŒ€ì „':'ëŒ€ì „','ëŒ€êµ¬':'ëŒ€êµ¬','ê´‘ì£¼':'ê´‘ì£¼','ì¸ì²œ':'ì¸ì²œ','ìš¸ì‚°':'ìš¸ì‚°','ì„¸ì¢…':'ì„¸ì¢…','ì œì£¼':'ì œì£¼' };
      if (map[s]) return map[s];
      return s || name;
    }

    // ======= Map coordinate pick handler (desktop: right-click, mobile: tap) =======
    async function handleMapCoordinatePick(e) {
      const { lat, lng } = e.latlng;
      const latInp = document.getElementById('add-lat');
      const lngInp = document.getElementById('add-lng');
      const nameInp = document.getElementById('add-name');
      const regionSel = document.getElementById('add-region');

      if (latInp) latInp.value = lat.toFixed(6);
      if (lngInp) lngInp.value = lng.toFixed(6);

      if (nameInp && !nameInp.value.trim()) {
        nameInp.value = `Drone ${getNextDroneId()}`;
      }

      if (regionSel && currentRegion && [...regionSel.options].some(o => o.value === currentRegion)) {
        regionSel.value = currentRegion;
      }

      const inferred = await getRegionNameFromCoords(lat, lng);

      if (inferred) {
        const hasRegion = Object.keys(regionData).some(r => r === inferred);
        if (!hasRegion) {
          alert(`${inferred} ì§€ì—­ì„ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”.`);
          showNotice(`${inferred} ì§€ì—­ì„ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”.`);
        } else {
          if (regionSel && regionSel.value && regionSel.value !== inferred) {
            alert(`í˜„ì¬ ì¢Œí‘œì™€ ì§€ì—­ì˜ ì¢Œí‘œê°€ ë‹¤ë¦…ë‹ˆë‹¤. (ì¶”ì²œ: ${inferred})`);
          } else if (regionSel && !regionSel.value) {
            regionSel.value = inferred;
          }
        }
      } else {
        showNotice(`ì¢Œí‘œ ì…ë ¥ë¨: ${lat.toFixed(6)}, ${lng.toFixed(6)} (ì§€ë„ ì„ íƒ)`);
      }
    }

    // Bind for desktop (right-click) and mobile (tap/click)
    map.on('contextmenu', handleMapCoordinatePick);
    const isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
    if (isTouch) {
      map.on('click', handleMapCoordinatePick);
    }
    (function(){
  const panel = document.getElementById('right-panel');
  if(!panel) return;

  // FAB ë²„íŠ¼ ì´ë™
  document.getElementById('fab-decode')?.addEventListener('click', ()=>{
    window.location.href = 'en&decode.html';
  });
  document.getElementById('fab-main')?.addEventListener('click', ()=>{
    window.location.href = 'main.html';
  });

  // === ëª¨ë°”ì¼ ìŠ¤ì™€ì´í”„ ì œìŠ¤ì²˜ ===
  let startY=null, currentY=null, isDragging=false;

  panel.addEventListener('touchstart', e=>{
    if(e.touches.length!==1) return;
    startY = e.touches[0].clientY;
    currentY = startY;
    isDragging = true;
    panel.style.transition = 'none';  // ë“œë˜ê·¸ ì‹œ ì¦‰ì‹œ ë°˜ì‘
  }, {passive:true});

  panel.addEventListener('touchmove', e=>{
    if(!isDragging) return;
    currentY = e.touches[0].clientY;
    const dy = currentY - startY;
    if(dy>0 && !panel.classList.contains('open')){ // ì•„ë˜ì—ì„œ ìœ„ë¡œ ì˜¬ë¦´ ë•Œ
      panel.style.transform = `translateY(calc(100% - 50px - ${Math.min(dy, window.innerHeight*0.7)}px))`;
    }else if(dy<0 && panel.classList.contains('open')){ // ìœ„ì—ì„œ ì•„ë˜ë¡œ ë‚´ë¦´ ë•Œ
      panel.style.transform = `translateY(${Math.min(Math.abs(dy), window.innerHeight*0.7)}px)`;
    }
  }, {passive:true});

  panel.addEventListener('touchend', ()=>{
    if(!isDragging) return;
    isDragging=false;
    panel.style.transition = 'transform .25s ease';

    if(!panel.classList.contains('open')){
      // ì•„ë˜ì—ì„œ ìœ„ë¡œ ìŠ¤ì™€ì´í”„ â†’ ì¼ì • ì´ìƒ ì˜¬ë¦¬ë©´ ì—´ê¸°
      const moved = startY - currentY;
      if(moved>60){ panel.classList.add('open'); }
      else { panel.style.transform = 'translateY(calc(100% - 50px))'; }
    }else{
      // ìœ„ì—ì„œ ì•„ë˜ë¡œ ìŠ¤ì™€ì´í”„ â†’ ì¼ì • ì´ìƒ ë‚´ë¦¬ë©´ ë‹«ê¸°
      const moved = currentY - startY;
      if(moved>60){ panel.classList.remove('open'); }
      else { panel.style.transform = 'translateY(0)'; }
    }
  });
})();
</script>
<!-- â–¼ ê³ ì • FAB: z-index ìµœìƒë‹¨ -->
<button id="fab-decode" class="fab fab-left" type="button" title="Decode">Decode</button>
<button id="fab-main"   class="fab fab-right" type="button" title="Go to Main">Main</button>

</body>
</html>
