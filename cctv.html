<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Drone CCTV Viewer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    /* ====== Layout & Global ====== */
    body {
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
      margin: 0;
      overflow: hidden;
    }
    #map { flex: 2; height: 100%; }
    .right-panel {
      flex: 1;
      background-color: #f7f7f7;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      overflow-y: auto;
    }

    /* ====== Search ====== */
    .search-container { margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
    .search-bar { width: 100%; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; }
    .search-icon { background-color: #000; color: #fff; border: none; padding: 10px 14px; border-radius: 4px; cursor: pointer; }
    .search-icon:hover { background-color: #333; }

    /* ====== Lists ====== */
    .drone-list { list-style-type: none; padding: 0; margin: 0; }
    .drone-item { display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 10px; border-bottom: 1px solid #ddd; }
    .drone-item:hover { background-color: #f0f0f0; }
    .drone-name { cursor: pointer; flex: 1; }
    .delete-btn { background: #eee; border: 1px solid #ccc; color: #333; width: 28px; height: 28px; border-radius: 4px; cursor: pointer; font-weight: bold; line-height: 1; }
    .delete-btn:hover { background: #e2e2e2; }

    /* ====== Drone detail / CCTV ====== */
    .drone-display { margin-top: 20px; text-align: center; }
    .drone-display p { font-size: 18px; margin-top: 10px; }

    .cctv-expanded {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(1);
      max-width: 85%;
      max-height: 90%;
      z-index: 1000;
      cursor: pointer;
      box-shadow: 0 0 20px rgba(0,0,0,.7);
      transition: transform .4s ease;
    }

    /* 실시간 스트림/미리보기 이미지 공통 스타일 */
    #cctv-image {
      width: 95%;
      max-width: 720px;
      transition: transform .4s ease;
    }

    .cctv-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,.7); z-index: 999; }

    /* ====== Buttons ====== */
    .back-button {
      margin-top: 20px; padding: 10px 20px; background-color: #000; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; display: none;
    }
    .back-button:hover { background-color: #333; }

    /* ====== Forms: Add Region / Add Drone ====== */
    .forms h4 { margin: 16px 0 8px; font-size: 16px; }
    .region-row { display: flex; gap: 8px; align-items: center; }
    .region-row input { flex: 1 1 auto; }
    .region-row button { flex: 0 0 auto; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .grid input, .grid select, .grid button { grid-column: 1 / -1; }

    .forms input, .forms select { padding: 8px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; }
    .btn { padding: 10px 24px; background: #000; color: #fff; border: 0; border-radius: 4px; cursor: pointer; }
    .btn:hover { background: #333; }
    .error { color: #c62828; font-size: 13px; display: none; width: 100%; }

    .repository { position: fixed; bottom: 20px; left: 20px; background: #676767; color: #fff; padding: 12px 14px; border-radius: 8px; cursor: pointer; z-index: 1000; }
    .repository:hover { background: #171717; }
    #add-drone-btn { width: 100%; box-sizing: border-box; padding: 8px; font-size: 14px; }

    .notice { display:none; color:#0b5ed7; font-size:12px; margin:6px 0; }
    .inline-logo { height: 1em; width: auto; vertical-align: -0.12em; margin: 0 6px; }

    @media (max-width: 768px) {
      #cctv-image { width: 100%; max-width: none; }
      .cctv-expanded { max-width: 95%; max-height: 95%; }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="right-panel">
    <div class="search-container">
      <input type="text" class="search-bar" id="search-bar" placeholder="Enter drone number (1-30)" onkeydown="checkEnter(event)" />
      <button class="search-icon" onclick="searchDrone()" title="Search by ID">&#8594;</button>
    </div>

    <div class="drone-display" id="drone-display"></div>

    <div id="notice" class="notice"></div>
    <ul class="drone-list" id="drone-list"></ul>

    <button class="back-button" id="back-button" onclick="goBack()">Back to Region</button>

    <div class="forms">
      <h4>Add Region</h4>
      <div class="region-row">
        <input id="region-name" type="text" placeholder="Region name" />
        <button class="btn" id="add-region-btn" onclick="addRegion()">Add Region</button>
      </div>
      <div id="region-error" class="error"></div>

      <h4>Add Drone</h4>
      <div class="grid" style="margin-top: 6px;">
        <input id="add-name" type="text" placeholder="Drone name" />
        <select id="add-region"></select>
        <input id="add-lat" type="number" step="any" placeholder="Latitude" />
        <input id="add-lng" type="number" step="any" placeholder="Longitude" />
        <button class="btn" id="add-drone-btn" onclick="addDrone()">Add Drone</button>
      </div>
      <div id="add-error" class="error"></div>
    </div>
  </div>

  <div class="repository" onclick="openStorage()">Repository</div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    /* ============================ Config ============================ */
    // 라즈베리파이 MJPEG 스트림 기본 URL (mjpg-streamer 예: http://<pi-ip>:8080/?action=stream)
    const DEFAULT_STREAM_URL = 'http://192.168.137.98:5002/video_feed'; // <-- 여기만 네트워크 환경에 맞게 바꾸세요

    /* ============== Data (in-memory) & Map bootstrap ============== */
    const regionData = {
      Seoul: [
        { id: 1, name: 'Drone 1', lat: 37.5665, lng: 126.9780 /*, stream: 'http://192.168.0.51:8080/?action=stream'*/ },
        { id: 2, name: 'Drone 2', lat: 37.5675, lng: 126.9790 }
      ],
      Busan: [
        { id: 3, name: 'Drone 3', lat: 35.1796, lng: 129.0756 }
      ]
    };

    let currentRegion = null;
    const markersById = new Map();
    let noticeTimer = null;

    const map = L.map('map').setView([37.5665, 126.9780], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    /* ============================== Map ============================== */
    function addDroneToMap(drone) {
      const marker = L.marker([drone.lat, drone.lng]).addTo(map);
      marker.on('click', () => {
        displayDroneInfo(drone);
        map.setView([drone.lat, drone.lng], 18);
      });
      markersById.set(drone.id, marker);
    }

    function removeDroneFromMap(droneId) {
      const marker = markersById.get(droneId);
      if (marker) { map.removeLayer(marker); markersById.delete(droneId); }
    }

    /* ============================ Rendering ============================ */
    function renderRegionNames() {
      const list = document.getElementById('drone-list');
      list.innerHTML = '';
      Object.keys(regionData).forEach(region => {
        const li = document.createElement('li');
        li.className = 'drone-item';
        li.innerHTML = `<span class="drone-name">${region}</span>`;
        li.querySelector('.drone-name').onclick = () => displayRegion(region);
        list.appendChild(li);
      });
    }

    function renderRegionList(region) {
      const list = document.getElementById('drone-list');
      list.innerHTML = '';
      (regionData[region] || []).forEach(drone => {
        const li = document.createElement('li');
        li.className = 'drone-item';
        li.innerHTML = `
          <span class="drone-name">${drone.name}</span>
          <button class="delete-btn" title="Delete">×</button>
        `;
        li.querySelector('.drone-name').onclick = () => {
          displayDroneInfo(drone);
          map.setView([drone.lat, drone.lng], 18);
        };
        li.querySelector('.delete-btn').onclick = (e) => {
          e.stopPropagation();
          deleteDrone(region, drone.id);
        };
        list.appendChild(li);
      });
    }

    /* ====================== Region / Drone details ====================== */
    function displayRegion(region) {
      currentRegion = region;
      renderRegionList(region);
      document.getElementById('back-button').style.display = 'block';

      const drones = regionData[region] || [];
      if (drones.length > 0) {
        const bounds = L.latLngBounds(drones.map(d => [d.lat, d.lng]));
        map.fitBounds(bounds, { padding: [40, 40], maxZoom: 14 });
      }
    }

    // 드론별 스트림 URL 결정 (드론 개별 stream 우선, 없으면 기본값)
    function getStreamUrl(drone) {
      return drone.stream || DEFAULT_STREAM_URL;
    }

    function displayDroneInfo(drone) {
      const display = document.getElementById('drone-display');
      const streamUrl = getStreamUrl(drone);

      // MJPEG은 <img>로 바로 표시 가능. (RTSP는 브라우저 미지원 → HLS/WebRTC 필요)
      display.innerHTML = `
        <p>${drone.name} <img src="../images/logo2.png" alt="logo" class="inline-logo" /> (${drone.lat}, ${drone.lng})</p>
        <img src="${streamUrl}" id="cctv-image" alt="Live CCTV Stream" />
      `;

      document.getElementById('back-button').style.display = 'block';

      // 확대 토글 그대로 유지
      const img = document.getElementById('cctv-image');
      img.onclick = () => toggleCCTVZoom();

      // 스트림 연결 실패 시 폴백 + 공지
      img.addEventListener('error', () => {
        showNotice('스트림에 연결할 수 없습니다. (임시 이미지로 표시)');
        img.src = './images/cctv.png';
      }, { once: true });
    }

    function toggleCCTVZoom() {
      const img = document.getElementById('cctv-image');
      const overlay = document.querySelector('.cctv-overlay');
      if (img.classList.contains('cctv-expanded')) {
        img.classList.remove('cctv-expanded');
        if (overlay) overlay.remove();
      } else {
        img.classList.add('cctv-expanded');
        if (!overlay) {
          const newOverlay = document.createElement('div');
          newOverlay.className = 'cctv-overlay';
          document.body.appendChild(newOverlay);
        }
      }
    }

    /* ============================== CRUD ============================== */
    function deleteDrone(region, id) {
      regionData[region] = (regionData[region] || []).filter(d => d.id !== id);
      removeDroneFromMap(id);
      renderRegionList(region);
      document.getElementById('drone-display').innerHTML = '';
    }

    function goBack() {
      currentRegion = null;
      document.getElementById('drone-display').innerHTML = '';
      renderRegionNames();
      document.getElementById('back-button').style.display = 'none';
    }

    /* ============================= Search ============================= */
    function searchDrone() {
      const val = parseInt(document.getElementById('search-bar').value);
      if (isNaN(val)) { alert('Enter a numeric drone id'); return; }
      for (const region in regionData) {
        const found = (regionData[region] || []).find(d => d.id === val);
        if (found) {
          displayDroneInfo(found);
          map.setView([found.lat, found.lng], 18);
          document.getElementById('back-button').style.display = 'block';
          return;
        }
      }
      alert('Not found');
    }
    function checkEnter(e) { if (e.key === 'Enter') searchDrone(); }

    /* ============================ Helpers ============================ */
    function getNextDroneId() {
      let max = 0;
      for (const region in regionData) {
        (regionData[region] || []).forEach(d => { if (d.id > max) max = d.id; });
      }
      return max + 1;
    }

    function showNotice(msg) {
      const el = document.getElementById('notice');
      el.textContent = msg;
      el.style.display = 'block';
      if (noticeTimer) clearTimeout(noticeTimer);
      noticeTimer = setTimeout(() => { el.style.display = 'none'; }, 2500);
    }

    function addDrone() {
      const name = document.getElementById('add-name').value.trim();
      const lat = parseFloat(document.getElementById('add-lat').value);
      const lng = parseFloat(document.getElementById('add-lng').value);
      const region = document.getElementById('add-region').value;
      const err = document.getElementById('add-error');

      if (!name || isNaN(lat) || isNaN(lng) || !region) {
        err.innerText = 'Fill all fields';
        err.style.display = 'block';
        return;
      }
      err.style.display = 'none';

      const newDrone = { id: getNextDroneId(), name, lat, lng /*, stream: 'http://<pi-ip>:8080/?action=stream'*/ };
      (regionData[region] || (regionData[region] = [])).push(newDrone);

      addDroneToMap(newDrone);
      if (currentRegion === region) renderRegionList(region); else renderRegionNames();

      showNotice('드론이 추가되었습니다.');
      document.getElementById('add-name').value = '';
      document.getElementById('add-lat').value = '';
      document.getElementById('add-lng').value = '';
    }

    function addRegion() {
      const name = document.getElementById('region-name').value.trim();
      const err = document.getElementById('region-error');
      if (!name || regionData[name]) {
        err.innerText = 'Invalid or exists';
        err.style.display = 'block';
        return;
      }
      err.style.display = 'none';
      regionData[name] = [];
      renderRegionNames();
      updateRegionDropdown();
      document.getElementById('region-name').value = '';
    }

    function updateRegionDropdown() {
      const sel = document.getElementById('add-region');
      sel.innerHTML = '';
      Object.keys(regionData).forEach(r => {
        const opt = document.createElement('option');
        opt.value = r; opt.innerText = r; sel.appendChild(opt);
      });
    }

    function openStorage() { alert('Path: ../창의문제해결프로젝트/images/'); }

    window.onload = () => {
      renderRegionNames();
      for (const region in regionData) {
        (regionData[region] || []).forEach(drone => addDroneToMap(drone));
      }
      updateRegionDropdown();
    };
  </script>
</body>
</html>
