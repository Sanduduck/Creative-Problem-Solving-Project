<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Drone CCTV Viewer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    /* ====== Layout & Global ====== */
    body {
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
      margin: 0;
      overflow: hidden;
    }
    #map { flex: 2; height: 100%; }
    .right-panel {
      flex: 1;
      background-color: #f7f7f7;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      overflow-y: auto;
    }

    /* ====== Search ====== */
    .search-container { margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
    .search-bar { width: 100%; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; }
    .search-icon { background-color: #000; color: #fff; border: none; padding: 10px 14px; border-radius: 4px; cursor: pointer; }
    .search-icon:hover { background-color: #333; }

    /* ====== Lists ====== */
    .drone-list { list-style-type: none; padding: 0; margin: 0; }
    .drone-item { display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 10px; border-bottom: 1px solid #ddd; }
    .drone-item:hover { background-color: #f0f0f0; }
    .drone-name { cursor: pointer; flex: 1; }
    .delete-btn { background: #eee; border: 1px solid #ccc; color: #333; width: 28px; height: 28px; border-radius: 4px; cursor: pointer; font-weight: bold; line-height: 1; }
    .delete-btn:hover { background: #e2e2e2; }

    /* ====== Drone detail / CCTV ====== */
    .drone-display { margin-top: 20px; text-align: center; }
    .drone-display p { font-size: 18px; margin-top: 10px; }

    .cctv-expanded {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(1);
      max-width: 85%;
      max-height: 90%;
      z-index: 1000;
      cursor: pointer;
      box-shadow: 0 0 20px rgba(0,0,0,.7);
      transition: transform .4s ease;
    }

    /* 실시간 스트림/미리보기 이미지 공통 스타일 */
    #cctv-image {
      width: 95%;
      max-width: 720px;
      transition: transform .4s ease;
    }

    .cctv-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,.7); z-index: 999; }

    /* ====== Buttons ====== */
    .back-button {
      margin-top: 20px; padding: 10px 20px; background-color: #000; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; display: none;
    }
    .back-button:hover { background-color: #333; }

    /* ====== Forms: Add Region / Add Drone ====== */
    .forms h4 { margin: 16px 0 8px; font-size: 16px; }
    .region-row { display: flex; gap: 8px; align-items: center; }
    .region-row input { flex: 1 1 auto; }
    .region-row button { flex: 0 0 auto; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .grid input, .grid select, .grid button { grid-column: 1 / -1; }

    .forms input, .forms select { padding: 8px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; }
    .btn { padding: 10px 24px; background: #000; color: #fff; border: 0; border-radius: 4px; cursor: pointer; }
    .btn:hover { background: #333; }
    .error { color: #c62828; font-size: 13px; display: none; width: 100%; }

    /* 좌하단 버튼: Decode 페이지로 이동 */
    .repository { position: fixed; bottom: 20px; left: 20px; background: #676767; color: #fff; padding: 12px 14px; border-radius: 8px; cursor: pointer; z-index: 1000; }
    .repository:hover { background: #171717; }
    #add-drone-btn { width: 100%; box-sizing: border-box; padding: 8px; font-size: 14px; }

    /* 사진 바로 아래 · 목록 위, 가운데 정렬 + 빨강 + 조금 크게 */
    .notice {
      display: none;
      color: #d32f2f;
      font-size: 14px;
      margin: 10px 0 6px;
      text-align: center;
    }

    /* 항상 포함 (inline 로고) */
    .inline-logo { height: 1em; width: auto; vertical-align: -0.12em; margin: 0 6px; }

    /* 확대 상태에서 하단 컨트롤(캡쳐/저장) — 화면 가로 중앙 정렬 */
    .cctv-controls {
      position: fixed;
      z-index: 1001;
      display: flex;
      gap: 12px;
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,.15);
      transform: translateX(-50%);
    }
    .cctv-btn {
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      background: #000;
      color: #fff;
    }
    .cctv-btn:hover { background: #333; }

    /* ====== Region list controls (정렬 버튼) ====== */
    .list-controls {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin: 6px 0 6px;
    }
    .sort-btn {
      padding: 6px 10px;
      font-size: 12px;
      border: 1px solid #bbb;
      border-radius: 6px;
      background: #fff;
      cursor: pointer;
    }
    .sort-btn.active { border-color:#000; }

    @media (max-width: 768px) {
      #cctv-image { width: 100%; max-width: none; }
      .cctv-expanded { max-width: 95%; max-height: 95%; }
    }
    /* ===== 모바일에서 Add Region을 Add Drone처럼 1열 풀넓이로 ===== */
@media (max-width: 768px){
  .forms .region-row{
    display: grid;              /* flex → grid 로 바꿔서 한 줄씩 쌓이게 */
    grid-template-columns: 1fr; /* 1열 */
    gap: 8px;
  }
  .forms .region-row input{
    width: 100%;
    font-size: 16px;            /* 터치 타겟 키우기 */
    min-height: 40px;
  }
  .forms .region-row button{
    width: 100%;                /* 버튼도 풀넓이 */
    padding: 10px 24px;
    font-size: 16px;
  }
}

  </style>
</head>
<body>
  <div id="map"></div>

  <div class="right-panel">
    <div class="search-container">
      <input type="text" class="search-bar" id="search-bar" placeholder="Enter drone number (1-30)" onkeydown="checkEnter(event)" />
      <button class="search-icon" onclick="searchDrone()" title="Search by ID">&#8594;</button>
    </div>

    <div class="drone-display" id="drone-display"></div>

    <!-- 사진 바로 아래 / 목록 위 / 가운데 정렬 -->
    <div id="notice" class="notice"></div>

    <!-- ▼ Region 목록 정렬 컨트롤 (오른쪽 끝) -->
    <div class="list-controls" id="sort-controls">
      <button class="sort-btn" data-mode="insert">추가순</button>
      <button class="sort-btn" data-mode="insertDesc">추가역순</button>
      <button class="sort-btn" data-mode="alpha">가나다</button>
      <button class="sort-btn" data-mode="alphaDesc">가나다역순</button>
    </div>

    <ul class="drone-list" id="drone-list"></ul>

    <button class="back-button" id="back-button" onclick="goBack()">Back to Region</button>

    <div class="forms">
      <h4>Add Region</h4>
      <div class="region-row">
        <input id="region-name" type="text" placeholder="Region name" />
        <button class="btn" id="add-region-btn" onclick="addRegion()">Add Region</button>
      </div>
      <div id="region-error" class="error"></div>

      <h4>Add Drone</h4>
      <div class="grid" style="margin-top: 6px;">
        <input id="add-name" type="text" placeholder="Drone name" />
        <select id="add-region"></select>
        <input id="add-lat" type="number" step="any" placeholder="Latitude" />
        <input id="add-lng" type="number" step="any" placeholder="Longitude" />
        <button class="btn" id="add-drone-btn" onclick="addDrone()">Add Drone</button>
      </div>
      <div id="add-error" class="error"></div>
    </div>
  </div>

  <!-- 좌하단 버튼: Decode 페이지로 이동 -->
  <div class="repository" id="decode-btn" role="button" aria-label="Open Encrypt/Decrypt">Decode</div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    /* ============================ Config ============================ */
    const DEFAULT_STREAM_URL = 'http://192.168.137.98:5002/video_feed'; // 환경에 맞게 수정

    /* ============== Data (in-memory) & Map bootstrap ============== */
    const regionData = {
      Seoul: [
        { id: 1, name: 'Drone 1', lat: 37.5665, lng: 126.9780 },
        { id: 2, name: 'Drone 2', lat: 37.5675, lng: 126.9790 }
      ],
      Busan: [
        { id: 3, name: 'Drone 3', lat: 35.1796, lng: 129.0756 }
      ]
    };

    let regionOrder = Object.keys(regionData);
    let regionSortMode = 'insert';
    let currentRegion = null;
    const markersById = new Map();

    const map = L.map('map').setView([37.5665, 126.9780], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // 마커 아이콘
    const blackIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-black.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]
    });
    const redIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]
    });

    /* ============================ ROLE ============================ */
    function getRole(){ return localStorage.getItem('ae_role') === 'admin' ? 'admin' : 'viewer'; }
    function isAdmin(){ return getRole() === 'admin'; }

    function applyRoleUI() {
      const admin = isAdmin();
      document.querySelectorAll('.forms input, .forms select, .forms .btn').forEach(el=>{ el.disabled = !admin; });
      document.querySelectorAll('.delete-btn').forEach(btn=>{ btn.style.display = admin ? '' : 'none'; });
    }

    /* ============================ 이름 정규화 & 전역 중복검사 ============================ */
    function normalizeName(s){
      return (s ?? '').toString().normalize('NFKC').toLowerCase().replace(/\s+/g, '');
    }
    function regionExists(name){
      const t = normalizeName(name);
      return Object.keys(regionData).some(r => normalizeName(r) === t);
    }
    function droneNameExists(name){
      const t = normalizeName(name);
      for (const region in regionData){
        const drones = regionData[region] || [];
        if (drones.some(d => normalizeName(d.name) === t)) return true;
      }
      return false;
    }

    /* ============================== Map ============================== */
    function addDroneToMap(drone) {
      const marker = L.marker([drone.lat, drone.lng], { icon: blackIcon }).addTo(map);
      marker.on('click', () => {
        displayDroneInfo(drone);
        map.setView([drone.lat, drone.lng], 18);
      });
      markersById.set(drone.id, marker);
    }
    function removeDroneFromMap(droneId) {
      const marker = markersById.get(droneId);
      if (marker) { map.removeLayer(marker); markersById.delete(droneId); }
    }
    function onStreamConnected(drone) {
      const m = markersById.get(drone.id);
      if (m) m.setIcon(redIcon);
    }
    function onStreamDisconnected(drone) {
      const m = markersById.get(drone.id);
      if (m) m.setIcon(blackIcon);
    }

    /* ============================ Region list ============================ */
    function getRegionList() {
      const names = Object.keys(regionData);
      if (regionSortMode === 'insert') {
        const extra = names.filter(n => !regionOrder.includes(n));
        return [...regionOrder, ...extra];
      }
      if (regionSortMode === 'insertDesc') {
        const base = getRegionListForInsertOnly();
        return base.slice().reverse();
      }
      if (regionSortMode === 'alpha') {
        return names.slice().sort((a,b)=>a.localeCompare(b, 'ko'));
      }
      if (regionSortMode === 'alphaDesc') {
        return names.slice().sort((a,b)=>b.localeCompare(a, 'ko'));
      }
      return names;
    }
    function getRegionListForInsertOnly() {
      const names = Object.keys(regionData);
      const extra = names.filter(n => !regionOrder.includes(n));
      return [...regionOrder, ...extra];
    }

    function renderRegionNames() {
      const list = document.getElementById('drone-list');
      list.innerHTML = '';
      const regions = getRegionList();
      regions.forEach(region => {
        const li = document.createElement('li');
        li.className = 'drone-item';
        li.innerHTML = `
          <span class="drone-name">${region}</span>
          <button class="delete-btn" title="Delete Region">×</button>
        `;
        li.querySelector('.drone-name').onclick = () => displayRegion(region);
        li.querySelector('.delete-btn').onclick = (e) => {
          e.stopPropagation();
          deleteRegion(region);
        };
        list.appendChild(li);
      });

      document.querySelectorAll('.sort-btn').forEach(b=>{
        b.classList.toggle('active', b.dataset.mode === regionSortMode);
      });
      applyRoleUI();
    }

    /* ============================ Drone list ============================ */
    function renderRegionList(region) {
      const list = document.getElementById('drone-list');
      list.innerHTML = '';
      (regionData[region] || []).forEach(drone => {
        const li = document.createElement('li');
        li.className = 'drone-item';
        li.innerHTML = `
          <span class="drone-name">${drone.name}</span>
          <button class="delete-btn" title="Delete">×</button>
        `;
        li.querySelector('.drone-name').onclick = () => {
          displayDroneInfo(drone);
          map.setView([drone.lat, drone.lng], 18);
        };
        li.querySelector('.delete-btn').onclick = (e) => {
          e.stopPropagation();
          deleteDrone(region, drone.id);
        };
        list.appendChild(li);
      });
      applyRoleUI();
    }

    /* ====================== Region / Drone details ====================== */
    function displayRegion(region) {
      currentRegion = region;
      renderRegionList(region);
      document.getElementById('back-button').style.display = 'block';

      const drones = regionData[region] || [];
      if (drones.length > 0) {
        const bounds = L.latLngBounds(drones.map(d => [d.lat, d.lng]));
        map.fitBounds(bounds, { padding: [40, 40], maxZoom: 14 });
      }
    }

    function getStreamUrl(drone) {
      return drone.stream || DEFAULT_STREAM_URL;
    }

    function displayDroneInfo(drone) {
      const display = document.getElementById('drone-display');
      const streamUrl = getStreamUrl(drone);

      // crossorigin="anonymous" 필수 (서버 CORS 허용 필요)
      display.innerHTML = `
        <p>${drone.name} <img src="./images/logo2.png" alt="logo" class="inline-logo" /> (${drone.lat}, ${drone.lng})</p>
        <img src="${streamUrl}" id="cctv-image" alt="Live CCTV Stream" crossorigin="anonymous" />
      `;

      document.getElementById('back-button').style.display = 'block';

      const img = document.getElementById('cctv-image');

      img.addEventListener('load', () => {
        const same = img.src.indexOf(streamUrl) === 0 || img.src === streamUrl;
        if (same) onStreamConnected(drone);
      }, { once: true });

      img.addEventListener('error', () => {
        showNotice('스트림에 연결할 수 없습니다. (임시 이미지로 표시)');
        img.src = './images/cctv.png';
        onStreamDisconnected(drone);
      }, { once: true });

      img.onclick = () => toggleCCTVZoom();
    }

    /* ===== 확대/축소 + 확대 시 하단 컨트롤 ===== */
    function toggleCCTVZoom() {
      const img = document.getElementById('cctv-image');
      const overlay = document.querySelector('.cctv-overlay');

      if (img.classList.contains('cctv-expanded')) {
        img.classList.remove('cctv-expanded');
        stopRecorder();
        removeControls();
        if (overlay) overlay.remove();
      } else {
        img.classList.add('cctv-expanded');
        if (!overlay) {
          const newOverlay = document.createElement('div');
          newOverlay.className = 'cctv-overlay';
          newOverlay.onclick = toggleCCTVZoom; // 오버레이 클릭으로 닫기
          document.body.appendChild(newOverlay);
        }
        createControlsForImage(img);
        startRecorderFromImage(img); // 확대 시 즉시 녹화 시작
      }
    }

    function createControlsForImage(img) {
      removeControls();
      const controls = document.createElement('div');
      controls.id = 'cctv-controls';
      controls.className = 'cctv-controls';
      controls.innerHTML = `
        <button type="button" class="cctv-btn" id="btn-capture">캡쳐</button>
        <button type="button" class="cctv-btn" id="btn-save">지금까지 녹화 저장</button>
      `;
      controls.addEventListener('click', e => e.stopPropagation());
      controls.addEventListener('mousedown', e => e.stopPropagation());
      document.body.appendChild(controls);
      positionControls(img, controls);
      controls._onResize = () => positionControls(img, controls);
      window.addEventListener('resize', controls._onResize);

      document.getElementById('btn-capture').onclick = (e)=>{ 
        e.stopPropagation(); 
        captureCurrentFrameEncrypted(); 
      };
      document.getElementById('btn-save').onclick = async (e)=>{
        e.stopPropagation();
        try { await saveRecordingEncrypted(); } catch(err){ console.error(err); }
      };
    }

    function positionControls(img, controls) {
      const r = img.getBoundingClientRect();
      controls.style.top  = (r.bottom + 12) + 'px';
      controls.style.left = (window.innerWidth / 2) + 'px';
    }

    function removeControls() {
      const controls = document.getElementById('cctv-controls');
      if (controls) {
        window.removeEventListener('resize', controls._onResize);
        controls.remove();
      }
    }

    /* ============================== CRUD ============================== */
    function deleteDrone(region, id) {
      if (!isAdmin()) { showNotice('권한이 없습니다. (관리자 전용)'); return; }
      regionData[region] = (regionData[region] || []).filter(d => d.id !== id);
      removeDroneFromMap(id);
      renderRegionList(region);
      document.getElementById('drone-display').innerHTML = '';
      saveAll();
    }

    function deleteRegion(region) {
      if (!isAdmin()) { showNotice('권한이 없습니다. (관리자 전용)'); return; }
      (regionData[region] || []).forEach(drone => removeDroneFromMap(drone.id));
      delete regionData[region];
      regionOrder = regionOrder.filter(r => r !== region);
      if (currentRegion === region) {
        currentRegion = null;
        document.getElementById('back-button').style.display = 'none';
        document.getElementById('drone-display').innerHTML = '';
      }
      renderRegionNames();
      updateRegionDropdown();
      saveAll();
    }

    function goBack() {
      currentRegion = null;
      document.getElementById('drone-display').innerHTML = '';
      renderRegionNames();
      document.getElementById('back-button').style.display = 'none';
    }

    /* ============================= Search ============================= */
    function searchDrone() {
      const val = parseInt(document.getElementById('search-bar').value);
      if (isNaN(val)) { alert('Enter a numeric drone id'); return; }
      for (const region in regionData) {
        const found = (regionData[region] || []).find(d => d.id === val);
        if (found) {
          displayDroneInfo(found);
          map.setView([found.lat, found.lng], 18);
          document.getElementById('back-button').style.display = 'block';
          return;
        }
      }
      alert('Not found');
    }
    function checkEnter(e) { if (e.key === 'Enter') searchDrone(); }

    /* ============================ Helpers ============================ */
    function getNextDroneId() {
      let max = 0;
      for (const region in regionData) {
        (regionData[region] || []).forEach(d => { if (d.id > max) max = d.id; });
      }
      return max + 1;
    }

    function showNotice(msg) {
      const el = document.getElementById('notice');
      el.textContent = msg;
      el.style.display = 'block';
    }

    function addDrone() {
      if (!isAdmin()) { showNotice('권한이 없습니다. (관리자 전용)'); return; }
      const name   = (document.getElementById('add-name').value || '').trim();
      const lat    = parseFloat(document.getElementById('add-lat').value);
      const lng    = parseFloat(document.getElementById('add-lng').value);
      const region = document.getElementById('add-region').value;
      const err    = document.getElementById('add-error');

      if (!name || isNaN(lat) || isNaN(lng) || !region) {
        err.innerText = 'Fill all fields';
        err.style.display = 'block';
        return;
      }
      if (droneNameExists(name)) {
        err.innerText = '이미 같은 이름의 드론이 존재합니다.';
        err.style.display = 'block';
        return;
      }

      err.style.display = 'none';

      const newDrone = { id: getNextDroneId(), name, lat, lng };
      (regionData[region] || (regionData[region] = [])).push(newDrone);

      addDroneToMap(newDrone);
      if (currentRegion === region) renderRegionList(region); else renderRegionNames();

      showNotice('드론이 추가되었습니다.');
      document.getElementById('add-name').value = '';
      document.getElementById('add-lat').value  = '';
      document.getElementById('add-lng').value  = '';

      saveAll();
    }

    function addRegion() {
      if (!isAdmin()) { showNotice('권한이 없습니다. (관리자 전용)'); return; }
      const name = (document.getElementById('region-name').value || '').trim();
      const err  = document.getElementById('region-error');

      if (!name) { err.innerText = 'Region name is required'; err.style.display = 'block'; return; }
      if (regionExists(name)) { err.innerText = '이미 추가된 지역입니다.'; err.style.display = 'block'; return; }

      err.style.display = 'none';
      regionData[name] = [];
      regionOrder.push(name);
      renderRegionNames();
      updateRegionDropdown();
      document.getElementById('region-name').value = '';
      saveAll();
    }

    function updateRegionDropdown() {
      const sel = document.getElementById('add-region');
      sel.innerHTML = '';
      Object.keys(regionData).forEach(r => {
        const opt = document.createElement('option');
        opt.value = r; opt.innerText = r; sel.appendChild(opt);
      });
    }

    // Decode 버튼 → en&decode.html로 이동 (파일명에 & 있으면 %26으로)
    document.getElementById('decode-btn')?.addEventListener('click', () => {
      window.location.href = 'en%26decode.html';
    });

    // 정렬 버튼 클릭
    document.getElementById('sort-controls').addEventListener('click', (e)=>{
      const btn = e.target.closest('.sort-btn');
      if (!btn) return;
      regionSortMode = btn.dataset.mode;
      renderRegionNames();
    });

    /* ============================ PERSIST ============================ */
    const LS_KEYS = {
      data:  'ae_regionData_v1',
      order: 'ae_regionOrder_v1'
    };

    function saveAll(){
      try{
        localStorage.setItem(LS_KEYS.data,  JSON.stringify(regionData));
        localStorage.setItem(LS_KEYS.order, JSON.stringify(regionOrder));
      }catch(e){ console.warn('[persist] save failed', e); }
    }

    function loadAll(){
      try{
        const d = localStorage.getItem(LS_KEYS.data);
        const o = localStorage.getItem(LS_KEYS.order);

        if (d){
          const parsed = JSON.parse(d);
          if (parsed && typeof parsed === 'object'){
            Object.keys(regionData).forEach(k => delete regionData[k]);
            Object.keys(parsed).forEach(k => regionData[k] = parsed[k]);
          }
        }
        if (o){
          const arr = JSON.parse(o);
          if (Array.isArray(arr)) regionOrder = arr;
        }
      }catch(e){ console.warn('[persist] load failed', e); }
    }

    /* ============================ INIT ============================ */
    window.onload = () => {
      loadAll();
      renderRegionNames();
      for (const region in regionData) {
        (regionData[region] || []).forEach(drone => addDroneToMap(drone));
      }
      updateRegionDropdown();
      applyRoleUI();  // 처음 진입 시 역할 반영

      const _regionNameInput = document.getElementById('region-name');
      if (_regionNameInput) {
        _regionNameInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') { e.preventDefault(); addRegion(); }});
      }

      ['add-name','add-lat','add-lng','add-region'].forEach(id=>{
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') { e.preventDefault(); addDrone(); }});
      });
    };

    /* ================== 녹화/캡처 + 암호화(매번 비번 묻기) ================== */

    // --- AES-GCM + PBKDF2 (en&decode.html과 동일 헤더 포맷) ---
    const MAGIC = new TextEncoder().encode('VIDENC01'); // 8 bytes
    const ALG_ID = 1;                          // 1 = AES-GCM-256
    const DEFAULT_ITERS = 310000;

    function u32(n){ const b=new Uint8Array(4); new DataView(b.buffer).setUint32(0,n,true); return b; }
    function concatBytes(...arrs){
      let len=0; for(const a of arrs) len+=a.byteLength||a.length;
      const out=new Uint8Array(len); let off=0;
      for(const a of arrs){ const v=a instanceof Uint8Array? a : new Uint8Array(a); out.set(v, off); off+=v.byteLength; }
      return out;
    }
    async function deriveKey(password, salt, iterations=DEFAULT_ITERS){
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']);
      return crypto.subtle.deriveKey(
        { name:'PBKDF2', hash:'SHA-256', salt, iterations },
        keyMaterial,
        { name:'AES-GCM', length:256 },
        false,
        ['encrypt','decrypt']
      );
    }
    async function encryptBlobToVenc(blob, filename, password){
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const iv   = crypto.getRandomValues(new Uint8Array(12));
      const key  = await deriveKey(password, salt, DEFAULT_ITERS);

      const pt   = new Uint8Array(await blob.arrayBuffer());
      const ct   = new Uint8Array(await crypto.subtle.encrypt({ name:'AES-GCM', iv }, key, pt));

      const enc = new TextEncoder();
      const nameBytes = enc.encode(filename || 'capture.png');
      const mimeBytes = enc.encode(blob.type || 'image/png');

      const header = concatBytes(
        MAGIC,
        u32(ALG_ID), u32(DEFAULT_ITERS),
        u32(salt.byteLength), u32(iv.byteLength),
        u32(nameBytes.byteLength), u32(mimeBytes.byteLength),
        salt, iv, nameBytes, mimeBytes
      );
      return new Blob([header, ct], { type:'application/octet-stream' });
    }

    // --- 매번 비밀번호 입력 헬퍼 ---
    function askPassword(purposeText){
      const pw = prompt(`${purposeText}에 사용할 비밀번호를 입력하세요\n(en&decode.html에서 복호화 시 동일 비밀번호 필요)`);
      if (!pw) {
        showNotice('암호가 필요합니다.');
        throw new Error('password_cancelled');
      }
      return pw;
    }

    // --- 전역 녹화 상태 ---
    const rec = {
      canvas: null,
      ctx: null,
      stream: null,
      recorder: null,
      chunks: [],
      rafId: null
    };

    function supportsMime(m){
      return typeof MediaRecorder !== 'undefined' && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(m);
    }

    // 이미지 → 캔버스 → captureStream → MediaRecorder로 누적
    function startRecorderFromImage(img){
      stopRecorder(); // 안전 차단

      // 이미지가 로드되었는지 확인
      if(!img || !img.complete || img.naturalWidth === 0){
        showNotice('이미지 로딩 중입니다. 잠시 후 다시 시도하세요.');
        return;
      }

      // 캔버스 준비(원본 해상도 기준)
      const cw = img.naturalWidth;
      const ch = img.naturalHeight;
      const canvas = document.createElement('canvas');
      canvas.width = cw; canvas.height = ch;
      const ctx = canvas.getContext('2d', { willReadFrequently:true });

      // draw loop
      function draw(){
        try{
          ctx.drawImage(img, 0, 0, cw, ch);
        }catch(e){
          // CORS 실패 시 drawImage에서 SecurityError 발생
          console.error('drawImage error (CORS?)', e);
          showNotice('CORS 문제로 녹화/캡처가 제한됩니다. 서버에 Access-Control-Allow-Origin 헤더를 설정하세요.');
          stopRecorder();
          return;
        }
        rec.rafId = requestAnimationFrame(draw);
      }
      rec.canvas = canvas;
      rec.ctx = ctx;

      // 캡처 프레임레이트
      const stream = canvas.captureStream(30); // 30fps
      rec.stream = stream;

      // 코덱 선택
      let mime = 'video/webm;codecs=vp9';
      if (!supportsMime(mime)) mime = 'video/webm;codecs=vp8';
      if (!supportsMime(mime)) mime = 'video/webm';

      try{
        const recorder = new MediaRecorder(stream, { mimeType: mime, videoBitsPerSecond: 4_000_000 });
        recorder.ondataavailable = (e)=>{ if(e.data && e.data.size>0) rec.chunks.push(e.data); };
        recorder.start(1000); // 1초마다 청크
        rec.recorder = recorder;
        draw();
      }catch(e){
        console.error('MediaRecorder 시작 실패', e);
        showNotice('브라우저가 MediaRecorder를 지원하지 않거나 권한 문제가 있습니다.');
        stopRecorder();
      }
    }

    function stopRecorder(){
      try{
        if(rec.rafId){ cancelAnimationFrame(rec.rafId); rec.rafId = null; }
        if(rec.recorder && rec.recorder.state !== 'inactive'){
          rec.recorder.stop();
        }
        if(rec.stream){
          rec.stream.getTracks().forEach(t=>t.stop());
        }
      }catch(e){ /* noop */ }
      rec.recorder = null;
      rec.stream = null;
      rec.canvas = null;
      rec.ctx = null;
    }

    // --- 캡처: 현재 프레임 PNG → .venc 저장 (매번 비번) ---
    async function captureCurrentFrameEncrypted(){
      try{
        const img = document.getElementById('cctv-image');
        if(!img){ showNotice('이미지가 없습니다.'); return; }
        if(!img.complete || img.naturalWidth === 0){
          showNotice('프레임 로딩 중입니다. 잠시 후 다시 시도하세요.'); return;
        }

        const canvas = document.createElement('canvas');
        canvas.width  = img.naturalWidth;
        canvas.height = img.naturalHeight;
        const ctx = canvas.getContext('2d', { willReadFrequently:true });
        try{
          ctx.drawImage(img, 0, 0);
        }catch(e){
          console.error('drawImage error (CORS?)', e);
          showNotice('CORS 문제로 캡처가 제한됩니다. 서버에 CORS 헤더를 설정하세요.');
          return;
        }

        const pngBlob = await new Promise((resolve)=> canvas.toBlob(resolve, 'image/png', 0.92));
        if(!pngBlob){ showNotice('캡처 실패(캔버스)'); return; }

        const pw = askPassword('캡처 파일 암호화');

        const ts = new Date().toISOString().replace(/[:.]/g,'-');
        const baseName = `capture_${ts}.png`;
        const vencBlob = await encryptBlobToVenc(pngBlob, baseName, pw);

        const a = document.createElement('a');
        a.href = URL.createObjectURL(vencBlob);
        a.download = baseName + '.venc';
        document.body.appendChild(a);
        a.click();
        setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 1000);
        showNotice('캡처 저장 완료(암호화).');
      }catch(err){
        if (err?.message !== 'password_cancelled') {
          console.error(err);
          showNotice('캡처 오류: ' + (err?.message || String(err)));
        }
      }
    }

    // --- 지금까지 녹화 저장: WebM → .venc (매번 비번) ---
    async function saveRecordingEncrypted(){
      try{
        if (!rec) { showNotice('녹화 상태가 없습니다.'); return; }

        // 녹화가 진행 중이면 stop → onstop 이후 blob 만들기
        await new Promise(resolve=>{
          if (rec.recorder && rec.recorder.state !== 'inactive') {
            rec.recorder.onstop = resolve;
            try { rec.recorder.stop(); } catch(e){ resolve(); }
          } else { resolve(); }
        });

        const blob = new Blob(rec.chunks.slice(), { type:'video/webm' });
        rec.chunks.length = 0;

        if (!blob || blob.size === 0) {
          showNotice('저장할 녹화 데이터가 없습니다.');
          // 재시작 시도
          const img = document.getElementById('cctv-image');
          if (img) startRecorderFromImage(img);
          return;
        }

        const pw = askPassword('녹화 파일 암호화');

        const ts = new Date().toISOString().replace(/[:.]/g,'-');
        const baseName = `record_${ts}.webm`;
        const vencBlob = await encryptBlobToVenc(blob, baseName, pw);

        const a = document.createElement('a');
        a.href = URL.createObjectURL(vencBlob);
        a.download = baseName + '.venc';
        document.body.appendChild(a);
        a.click();
        setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 1000);
        showNotice('녹화 저장 완료(암호화).');

        // 사용자 편의: 즉시 다시 녹화 재시작
        const img = document.getElementById('cctv-image');
        if (img) startRecorderFromImage(img);
      }catch(err){
        if (err?.message !== 'password_cancelled') {
          console.error(err);
          showNotice('녹화 저장 오류: ' + (err?.message || String(err)));
        }
      }
    }
  </script>
</body>
</html>

